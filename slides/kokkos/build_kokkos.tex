%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\begin{frame}
  \frametitle{Build kokkos}

  \begin{itemize}
  \item \textbf{Kokkos is still experimental, but moving fast}
  \item \textbf{1. Get sources, development branch}
    \begin{itemize}
    \item \textcolor{blue}{Practicals on \texttt{ouessant}:}\\
      \texttt{1. mkdir \$HOME/kokkos-tutorial; cd \$HOME/kokkos-tutorial}\\
      some tutorial examples are already configured for using that precise location.\\
      \texttt{2. git clone https://github.com/kokkos/kokkos}\\
      \texttt{3. cd kokkos; git checkout develop}
    \end{itemize}
  \item \textbf{2. Build configuration}
    \begin{itemize}
    \item \texttt{mkdir build; cd build}
    \item About build system, several ways to use Kokkos
      \begin{enumerate}
      \item Only when Kokkos is build inside \myhref{https://github.com/trilinos/Trilinos}{Trilinos}, \myhref{https://cmake.org/}{CMake} is used
      \item Standalone utilization: use \texttt{generate\_makefile.bash}, then \texttt{make kokkoslib; make install}
      \item Embedded Kokkos source files in your application.
      \end{enumerate}
      % \item We will use 2. and 3.
    \end{itemize}
  \end{itemize}
 
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\begin{frame}
  \frametitle{Build kokkos (2)}

  \begin{itemize}
  \item \textcolor{blue}{\textbf{Example build configurations}}
    \begin{itemize}
    \item For \texttt{ouessant}, see file \texttt{doc/readme\_build\_kokkos\_ouessant} in the provided archive
    \item Serial (mostly for testing)\\
      \texttt{../generate\_makefile.bash --with-serial --prefix=\$HOME/local/kokkos\_serial}
    \item \textbf{OpenMP}\\
      \texttt{../generate\_makefile.bash --with-openmp --prefix=\$HOME/local/kokkos\_openmp\_dev}
    \item \textbf{CUDA (+ OpenMP)}; typical configuration\\
      \texttt{../generate\_makefile.bash --with-cuda --arch=Pascal60 --prefix=\$HOME/local/kokkos\_cuda\_lambda\_openmp --with-cuda-options=enable\_lambda --with-openmp --with-hwloc=/usr}
    \end{itemize}
  \item \textcolor{darkgreen}{\textbf{After installation}} (\texttt{make kokkoslib; make install;} the file \texttt{Makefile.kokkos} is created, and designed to be reused in the application build system.
    \begin{itemize}
    \item There can be a quite large combinatorics of \texttt{DEVICES}, \texttt{ARCH}, compilers, compiler options, ...
    \end{itemize}
  \item Important notices:
  \end{itemize}
  
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\begin{frame}
  \frametitle{Kokkos - Documentation}

  \begin{itemize}
  \item PDF documentation in kokkos source tree : \texttt{doc/Kokkos\_PG.pdf} (programming guide)
  \item \myhref{http://www.stack.nl/~dimitri/doxygen/}{Doxygen} can only be built from inside \myhref{https://github.com/trilinos/Trilinos}{Trilinos source tree}\\
    Version of the day can be browsed at \myurl{https://trilinos.org/docs/dev/packages/kokkos/doc/html/index.html}
  \item Kokkos source code itself, reading unit tests code is also helpful
  \end{itemize}

  Additionnal resources:

  \begin{itemize}
  \item Tutorial slides and codes: \\
    \myurl{https://github.com/kokkos/kokkos-tutorials}
  \end{itemize}
  
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\begin{frame}[fragile=singleslide]
  \frametitle{Kokkos - initialize / finalize}

  \begin{itemize}
  \item \texttt{Kokkos::initialize / finalize}
    %// introspection on configuration options
    \begin{minted}{c++}
      #include <Kokkos_Macros.hpp>
      #include <Kokkos_Core.hpp>
      
      int main(int argc, char* argv[]) {
        // default: initialize the host exec space
        // What exactly gets initialized depends on how kokkos
        // was built, i.e. which options was passed to
        // generate_makefile.bash
        Kokkos::initialize();
        ...
        Kokkos::finalize();
      }
    \end{minted}
    %
  \item \textcolor{red}{\textbf{What's happening inside \texttt{Kokkos::initialize}}}
    \begin{itemize}
    \item Defines \textcolor{blue}{\texttt{DefaultExecutionSpace}} (as specified when kokkos itself was built, by order of priority: Cuda > OpenMP > Threads > Serial)\\
      e.g. if \texttt{\-- \-- with-cuda} was not pass to \texttt{generate\_makefile.bash}, but \texttt{\-- \-- with-openmp} was, then \texttt{DefaultExecutionSpace} is OpenMP
    \item Defines a \textcolor{blue}{default memory space}
    \item all these will internally be used inside Kokkos sources as default (hidden) template parameters
    \end{itemize}
    % 
  \end{itemize}
  %
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\begin{frame}[fragile=singleslide]
  \frametitle{Kokkos - initialize / finalize}

  \begin{itemize}
  \item \texttt{Kokkos::initialize / finalize} (most of the time OK)
    % // introspection on configuration options
    \begin{minted}{c++}
      #include <Kokkos_Macros.hpp>
      #include <Kokkos_Core.hpp>
      
      int main(int argc, char* argv[]) {
        
        // default initialization
        Kokkos::initialize();
        ...
        Kokkos::finalize();
        
      }
    \end{minted}
    % 
  \item \textbf{Fine control of initialization:}
    \begin{itemize}
    \item \texttt{Kokkos::initialize(argc, argv);}\\
      User can change/fix e.g. number OpenMP threads on the application's command line
    \item This is regular initialization. If available \textcolor{orange}{\textbf{\texttt{hwloc}}} is used to decide:
      \begin{itemize}
      \item For OpenMP exec space: number of threads (default is all CPU cores)\\
        NB: usual envirinment variables (e.g. \texttt{OMP\_NUM\_THREADS} can be used
      \item Mapping between GPUs and MPI task
      \end{itemize}
    \end{itemize}
    % 
  \end{itemize}
  
\end{frame}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\begin{frame}[fragile=singleslide]
  \frametitle{Kokkos - initialize / finalize}

  \begin{itemize}
  \item \textcolor{red}{\textbf{Advanced initialization}} with \textcolor{blue}{\textbf{OpenMP + CUDA}}\\
    \textbf{Needed/usefull to be able to execution computation on both HOST / GPU}
  \end{itemize}
  \begin{minted}{c++}
    #if defined( KOKKOS_HAVE_CUDA )
    Kokkos::HostSpace::execution_space::initialize(teams*num_threads);
    Kokkos::Cuda::SelectDevice select_device(device);
    Kokkos::Cuda::initialize(select_device);
    #elif defined( KOKKOS_HAVE_OPENMP )
    Kokkos::OpenMP::initialize(teams*num_threads);
    #elif defined( KOKKOS_HAVE_PTHREAD )
    Kokkos::Threads::initialize(teams*num_threads);
    #endif
  \end{minted}
\end{frame}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\begin{frame}[fragile=singleslide]
  \frametitle{Kokkos - initialize / finalize ith MPI}

  \begin{itemize}
  \item \textcolor{red}{\textbf{Advanced initialization}} with \textcolor{blue}{\textbf{MPI + CUDA}}
    (we will come back into that with example code)
    \begin{minted}{c++}

      // MPI initialized above

      // probe the number of CUDA device (i.e. GPUs)
      const int ngpu = Kokkos::Cuda::detect_device_count();

      // provide a mapping 1 MPI task <-> 1 GPU
      const int cuda_device_rank = pre_mpi_local_rank % ngpu ;

      // each MPI task initialize the selected device id
      Kokkos::Cuda::initialize(
              Kokkos::Cuda::SelectDevice( cuda_device_rank ) );
    \end{minted}
  \end{itemize}
\end{frame}
